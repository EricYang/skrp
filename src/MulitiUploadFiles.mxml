<?xml version="1.0" encoding="utf-8"?>
<s:TitleWindow 
	xmlns:fx="http://ns.adobe.com/mxml/2009" 
	xmlns:s="library://ns.adobe.com/flex/spark" 
	xmlns:mx="library://ns.adobe.com/flex/mx" 
	xmlns:x2="x2.*"
	width="600" height="600"
	creationComplete="init()"  	 	
	preinitialize="{iR=Fun.getLang('FindStu')}"
	close="closeWin()"
	title="選擇圖片後，點選【確定上傳】按鈕開始上傳。"
	>
	<fx:Declarations>
		<!-- 
		將非可視元素（例如服務、值對象）放在此處
		url="http://localhost/uploader/cp.php?tt=1"
		-->
		<s:HTTPService id="album_service"
					   method="get"
					   resultFormat="text"					   
					   result="album_result(event);"
					   fault="album_fault(event);"/>
	</fx:Declarations>
	
	<fx:Script>
		<![CDATA[
			import mx.utils.StringUtil;
			
			import x2.*;
			[Bindable]
			private var iR:Object;			
			[Bindable]
			private var is_app:String = Fun.sApp;			
			public var fAfterOk:Function;
			[Bindable]
			private var i_session:Object = Fun.readJson(is_app, {type:"getSession", sessionName:["academicYear","semester","schoolDSn","usersSn"]});
			
			import mx.collections.ArrayCollection;
			import mx.controls.Alert;
			import mx.controls.ToolTip;
			import mx.core.INavigatorContent;
			import mx.core.mx_internal;
			import mx.rpc.events.FaultEvent;
			import mx.rpc.events.ResultEvent;
			import mx.utils.UIDUtil;
			
			import vo.PhotoVO;
			
			[Bindable]
			private var photos_ac:ArrayCollection;
			private var photos_album_ac:ArrayCollection;
			private var photos_class_ac:ArrayCollection;
			
			private var pendingFiles:Array;
			//文件列表；
			private var frl:FileReferenceList;
			//當前上傳的序號；
			private var currentIndex:int;
			//上傳路徑；
			private var isUploadComplete:Boolean=true;
			private var upload_url:String = Fun.sDirRoot + "/_app/cp.php";
			//private var upload_url:String="http://localhost/SKRP/dbUpLoadFiles/TeachersFolder/LearnPro/cp.php";
			private var fileUnique:Array;
			
			private function init():void
			{
				photos_ac=new ArrayCollection();
				frl=new FileReferenceList();
				frl.addEventListener(Event.SELECT,selectHandler);
			}
			
			private function album_result(e:ResultEvent):void
			{
			}
			
			private function album_fault(e:FaultEvent):void
			{
				trace("出錯啦");
			}
			
			private function upload_photos(e:MouseEvent):void
			{
				if(photos_ac!=null)
				{
					if(photos_ac.length!=0)
					{
						isUploadComplete=false;
						upload_btn.enabled=false;
						dg.editable=false;
						this.title = "正在上傳 .....";
						var photo:PhotoVO=photos_ac[currentIndex];
						var file:FileReference =photo.file;
						var title:String=photo.des;
						
						var fileTypeTmp:String = String(photo.file.type).toLowerCase();
						var fileNameTmp:String = StringUtil.trim('LearnPro_' + String(i_session.schoolDSn) + '_' + String(i_session.usersSn) + '_' + String(new Date().getTime()) + String(currentIndex) + fileTypeTmp);
						var ftFlag:int = 0;
						switch (fileTypeTmp){
							case ".jpg":
								ftFlag = 1;
								break;
							case ".gif":
								ftFlag = 2;
								break;
							case ".jpeg":
								ftFlag = 3;
								break;
							case ".png":
								ftFlag = 4;
								break;
							case ".mp4":
								ftFlag = 11;
								break;
							case ".avi":
								ftFlag = 12;
								break;
							case ".wmv":
								ftFlag = 13;
								break;
						}
						var para:String="?ac=flashsubmit&pathName="+Fun2.fLearnPro+"&fileName="+fileNameTmp+"&ftFlag="+ftFlag;
						photos_ac[currentIndex].name = fileNameTmp;
						
						//var para:String="?ac=flashsubmit&pic_title="+title;						
						file.upload(new URLRequest(upload_url+para));
						file.addEventListener(Event.COMPLETE, uploadCompleteHandler);
						file.addEventListener(ProgressEvent.PROGRESS,uploadprocessHandler);
						file.addEventListener(IOErrorEvent.IO_ERROR, ioErrorHandler);
						file.addEventListener(DataEvent.UPLOAD_COMPLETE_DATA,uploadCompleteDataHandler);
					}else{
						Fun.msg("I", "請 瀏覽選擇 要上傳的圖片！");
					}
				}else{
					Fun.msg("I", "請 瀏覽選擇 要上傳的圖片！");
				}
			}
			
			private function uploadCompleteDataHandler(event:DataEvent):void
			{
				if(!isUploadComplete)
				{
					dg.validateNow();
					var result:String=event.data;
					var photo:PhotoVO=photos_ac[currentIndex];;
					if(result=="1")
					{
						photo.progress="上傳成功";
					}else
					{
						photo.progress="上傳失敗";
					}
				}
			}
			
			private function ioErrorHandler(e:IOErrorEvent):void{
				Fun.msg("I", "IO 錯誤："+ e);
			}
			
			private function uploadCompleteHandler(e:Event):void
			{
				currentIndex++;
				if(currentIndex<photos_ac.length)
				{
					upload_photos(null);
				}else
				{
					var len:int=photos_ac.length;
					var ac:ArrayCollection=new ArrayCollection();
					var transData:Array = [];
					
					var photo:PhotoVO;
					for(var i:int=0;i<len;i++)
					{
						photo=photos_ac[i];
						if(photo.progress=="上傳失敗")
						{
							ac.addItem(photos_ac[i]);
						}else{
							var s_data:Object = {
								fileName: photos_ac[i].name								
							};
							transData.push(s_data);							
						}
					}
					if(ac.length!=0)
					{
						photos_ac=ac;
					}else
					{
						photos_ac=null;
					}
					currentIndex=0;
					isUploadComplete=true;
					upload_btn.enabled=true;
					dg.editable=true;
					this.title = "選擇圖片後，點選【確定上傳】按鈕開始上傳。";
					
					Fun2.aGlobal = transData;
					fAfterOk();
					Fun.msg("I", "上傳完畢。");
					Fun.closePopup(this);
				}
			}
			
			private function uploadprocessHandler(e:ProgressEvent):void
			{
				var proc:uint=e.bytesLoaded/e.bytesTotal*100;
				var progress:String=proc+"%";
				var photo:PhotoVO=photos_ac[currentIndex];
				photo.progress=progress;
				var ci:int=currentIndex+1;
				this.title = "正在上傳第 "+ ci +" 圖片，已完成 "+photo.progress;
			}
			
			private function delete_photos(e:MouseEvent):void
			{
				if(isUploadComplete)
				{
					var ac:ArrayCollection=new ArrayCollection();
					var array:Array=dg.selectedItems;
					var num:int=photos_ac.length;
					var isSelected:Boolean;
					for(var i:int=0;i<num;i++)
					{
						for(var n:int=0;n<array.length;n++)
						{
							if(photos_ac.getItemAt(i)["uid"]==array[n]["uid"])
							{
								isSelected=true;
								break;
							}else
							{
								isSelected=false;
							}
						}
						if(!isSelected)
						{       
							ac.addItem(photos_ac.getItemAt(i));
						}
					}
					photos_ac=ac;
				}else{
					Fun.msg("I", "正在上傳，請稍侯。");
				}
			}
			
			private function browse(e:MouseEvent):void
			{
				if(isUploadComplete){
					frl.browse([new FileFilter("Images", "*.jpg;*.png;*.gif;*.mp4;*.avi;*.wmv")]);
				}else{
					Fun.msg("I", "正在上傳，請稍侯。");
				}
			}
			
			private function selectHandler(event:Event):void {
				var fl:Array=frl.fileList;
				var file:FileReference;
				var photo:PhotoVO;
				var isAllow:Boolean;
				var index:int;
				var isTong:Boolean;
				var isHave:Boolean=false;
				
				if(photos_ac==null){
					photos_ac=new ArrayCollection();
				}
				if (fileUnique==null){
					fileUnique = new Array();
				}
				
				for (var i:uint = 0; i < fl.length; i++) {
					file = FileReference(fl[i]);
					
					for (var j:int=0; j<photos_ac.length; j++ ){
						if (file.name == photos_ac[j].name)
						{
							isHave = true;
							break;
						}
					}
					
					if (isHave){
						continue;
					}
					photo=new PhotoVO();
					photo.uid=UIDUtil.createUID();
					photo.file=file;
					photo.name=file.name;
					photo.des=file.name;
					photo.size=int(file.size/1024);
					if(photo.size<10000)
					{
						photos_ac.addItem(photo);
					}else{
						isAllow=true;
						break;
					}
				}
				if (isHave){
					Fun.msg("I", "請勿上傳重複的圖片。");
				}else if(isAllow){
					Fun.msg("I", "只允許上傳小於 10,000KB 的圖片。");
				}
				dg.dataProvider=photos_ac;
				
				//直接上傳圖檔
				//upload_photos(null);
			}
			public function genrowno(ob:Object):String {
				return String(dg.dataProvider.getItemIndex(ob)+1);				
			}
			private function closeWin():void{
				Fun.closePopup(this);
			}
		]]>
	</fx:Script>
	
	<s:HGroup x="10" y="10" width="578" height="40" verticalAlign="middle">
		<x2:BtnUploadView click="browse(event);"/>
		<x2:btnDelete id="delete_btn" click="delete_photos(event);"/>
		<s:DropDownList id="photos_album_ddl" visible="false"/>		
		<s:DropDownList id="photos_class_ddl" visible="false"/>		
	</s:HGroup>	
	<mx:HRule x="0" y="49" width="100%" id="theLine"/>
	<mx:DataGrid id="dg" x="10" y="58" width="578" height="470" allowMultipleSelection="true"
				 dataProvider="{photos_ac}" rowHeight="70" toolTip="按 Shift 鍵，可多選" dropShadowVisible="true">
		<mx:columns>
			<mx:DataGridColumn headerText="No." width="30" textAlign="right">
				<mx:itemRenderer>
					<fx:Component>
						<mx:Label text="{this.parentDocument.genrowno(data)}"/>									
					</fx:Component>
				</mx:itemRenderer>        		         
			</mx:DataGridColumn>
			<mx:DataGridColumn headerText="名稱" width="200" dataField="name"/>
			<mx:DataGridColumn headerText="重命名(留空表示用系統自動生成的名字)" dataField="des" visible="false"/>
			<!--
			<mx:DataGridColumn headerText="預覽" dataField="img" width="100" textAlign="center">
				<mx:itemRenderer>
					<fx:Component>
						<mx:Image height="70" source="../dbUpLoadFiles/TeachersFolder/LearnPro/img/{data.name}"/>
					</fx:Component>
				</mx:itemRenderer>        		         
			</mx:DataGridColumn>
			-->
			<mx:DataGridColumn headerText="大小(KB)" width="80" dataField="size" textAlign="right"/>
			<!--<mx:DataGridColumn headerText="進度" width="80" dataField="progress" editable="false"/>-->
		</mx:columns>
	</mx:DataGrid>
	<x2:BtnUpload id="upload_btn" x="10" y="535" click="upload_photos(event);"/>
</s:TitleWindow>
